{% extends "base.html" %}

{% block content %}
<div class="container mx-auto mt-10" data-page="cart">
    <h1 class="text-3xl font-bold text-center mb-6">üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h1>

    {% if cart_items %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for item in cart_items %}
        <div class="relative p-4 border rounded-lg shadow-md bg-white flex flex-col items-center"
             data-cart-item
             data-product-id="{{ item.product_id }}"
             data-product-name="{{ item.name }}"
             data-price="{{ item.price }}"
             data-quantity="{{ item.quantity }}">
            <img src="{{ url_for('static', path='images/' + item.product_id|string + '.webp') }}"
                 alt="–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞"
                 class="w-full h-40 object-contain rounded-md">

            <div class="text-center mt-2">
                <h2 class="text-xl font-semibold">{{ item.name }}</h2>
                <p class="text-gray-600 text-sm">{{ item.description }}</p>
                <p class="text-md text-blue-600">–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ: <strong>{{ item.product_quantity }}</strong></p>

                <button onclick="updateQuantity({{ item.product_id }}, -1)" class="qty-btn">‚ûñ</button>
                <input type="number" id="qty-{{ item.product_id }}"
                       class="qty-input" value="{{ item.quantity }}"
                       min="1" max="{{ item.product_quantity }}"
                       oninput="manualUpdate({{ item.product_id }})">
                <button onclick="updateQuantity({{ item.product_id }}, 1)" class="qty-btn">‚ûï</button>

                <p class="text-lg font-bold text-red-500">–í—Å–µ–≥–æ: <span id="total-{{ item.product_id }}">{{ item.total_cost }}</span>
                    ‚ÇΩ</p>
            </div>

            <button onclick="removeFromCart({{ item.product_id }})"
                    class="btn__del j-basket-item-del absolute bottom-2 right-2"
                    data-action="remove-from-cart"
                    data-product-id="{{ item.product_id }}"
                    data-product-name="{{ item.name }}">
                üóë
            </button>
        </div>
        {% endfor %}
    </div>

    <div class="text-center mt-6">
        <div class="mb-4">
            <p class="text-lg">
                –í–∞—à –±–∞–ª–∞–Ω—Å: <span id="user-balance" class="font-bold text-blue-600">–ó–∞–≥—Ä—É–∑–∫–∞...</span> ‚ÇΩ
            </p>
        </div>
        <h2 class="text-2xl font-bold">–ò—Ç–æ–≥–æ: <span id="cart-total">{{ total_cart_cost }}</span> ‚ÇΩ</h2>
        <button onclick="checkout()" 
                class="bg-green-500 text-white px-6 py-3 rounded-lg text-lg"
                data-action="checkout"
                data-total-value="{{ total_cart_cost }}"
                data-items-count="{{ cart_items|length }}">
            –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
        </button>
    </div>
    {% else %}
    <p class="text-center text-lg text-gray-600">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –µ—â—ë –ø—É—Å—Ç–∞, –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã</p>
    {% endif %}
</div>

<div id="orderModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    // –ó–∞—Ç–µ–º–Ω—ë–Ω–Ω—ã–π —Ñ–æ–Ω
    <div id="modalBackdrop" class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm"></div>

    <div id="modalContent" class="relative bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all animate-modal-appear">
        // –ò–∫–æ–Ω–∫–∞ —É—Å–ø–µ—Ö–∞
        <div class="flex justify-center mb-4">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center">
                <svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
        </div>

        <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!</h2>

        <p class="text-center text-gray-600 mb-6">
            –í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É. –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –≤–∞–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞ email.
        </p>

        <button onclick="closeOrderModal()" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200">
            –û—Ç–ª–∏—á–Ω–æ!
        </button>
    </div>
</div>

<script>
    async function updateQuantity(productId, change) {
        let input = document.getElementById(`qty-${productId}`);
        let newQuantity = parseInt(input.value) + change;

        if (newQuantity < 1) newQuantity = 1;
        if (newQuantity > input.max) newQuantity = input.max;

        input.value = newQuantity;
        await updateCart(productId, newQuantity);
    }

    async function manualUpdate(productId) {
        let input = document.getElementById(`qty-${productId}`);
        let newQuantity = parseInt(input.value);

        if (isNaN(newQuantity) || newQuantity < 1) newQuantity = 1;
        if (newQuantity > input.max) newQuantity = input.max;

        input.value = newQuantity;
        await updateCart(productId, newQuantity);
    }

    async function updateCart(productId, quantity) {
        try {
            const response = await (window.authFetch || fetch)(`/api/cart/cart/update/${productId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ quantity: quantity })
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById(`total-${productId}`).textContent = data.total_cost;
                document.getElementById("cart-total").textContent = data.cart_total;
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–æ—Ä–∑–∏–Ω—ã
                if (typeof updateCartBadge === 'function') {
                    await updateCartBadge();
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –±–∞–ª–∞–Ω—Å–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–æ–≤–æ–π —Å—É–º–º—ã
                await updateBalanceHighlight();
            } else {
                const errorData = await response.json().catch(() => ({ detail: "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞" }));
                alert(errorData.detail || "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞!");
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã:", error);
            alert("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞!");
        }
    }

    async function removeFromCart(productId) {
        try {
            const response = await (window.authFetch || fetch)(`/api/cart/cart/remove/${productId}`, { 
                method: 'DELETE' 
            });
            
            if (response.ok) {
                if (typeof updateCartBadge === 'function') {
                    await updateCartBadge();
                }
                location.reload();
            } else {
                const errorData = await response.json().catch(() => ({ detail: "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞" }));
                alert(errorData.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞!");
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞:", error);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞!");
        }
    }

    async function checkout() {
        try {
            const response = await (window.authFetch || fetch)("/api/order/orders/create", {
                method: "POST"
            });

            if (response.ok) {
                const data = await response.json();
                const itemsCount = document.querySelectorAll('[data-cart-item]').length;
                showOrderModal(data.order_id, data.total_cost, itemsCount);
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
                if (typeof window.updateBalance === 'function') {
                    await window.updateBalance();
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–æ—Ä–∑–∏–Ω—ã
                await loadBalance();
            } else {
                const errorData = await response.json().catch(() => ({ detail: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞" }));
                const errorMessage = errorData.detail || "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞";
                
                // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –Ω–µ—Ö–≤–∞—Ç–∫–∏ –±–∞–ª–∞–Ω—Å–∞
                if (errorMessage.includes("–±–∞–ª–∞–Ω—Å") || errorMessage.includes("–±–∞–ª–∞–Ω—Å–∞")) {
                    alert(`‚ùå ${errorMessage}\n\n–ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –≤ –ø—Ä–æ—Ñ–∏–ª–µ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞.`);
                } else {
                    alert(`‚ùå ${errorMessage}`);
                }
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:", error);
            alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞");
        }
    }

    function showOrderModal(orderId, totalCost, itemsCount) {
        const modal = document.getElementById("orderModal");
        modal.setAttribute('data-order-id', orderId);
        modal.setAttribute('data-total-value', totalCost);
        modal.setAttribute('data-items-count', itemsCount);
        modal.classList.remove("hidden");
        document.body.style.overflow = "hidden";
    }

    function closeOrderModal() {
        const modal = document.getElementById("orderModal");
        modal.classList.add("hidden");
        document.body.style.overflow = "";
        location.reload();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –±–∞–ª–∞–Ω—Å–∞
    async function updateBalanceHighlight() {
        const balanceElement = document.getElementById("user-balance");
        if (!balanceElement) return;
        
        const totalCost = parseInt(document.getElementById("cart-total").textContent) || 0;
        const balance = parseInt(balanceElement.textContent) || 0;
        
        if (balance < totalCost) {
            balanceElement.classList.remove("text-blue-600");
            balanceElement.classList.add("text-red-600");
        } else {
            balanceElement.classList.remove("text-red-600");
            balanceElement.classList.add("text-blue-600");
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
    async function loadBalance() {
        try {
            const response = await (window.authFetch || fetch)("/api/user/auth/me", {
                method: 'GET'
            });
            
            if (response.ok) {
                const userData = await response.json();
                const balance = userData.balance || 0;
                const balanceElement = document.getElementById("user-balance");
                if (balanceElement) {
                    balanceElement.textContent = balance;
                    await updateBalanceHighlight();
                }
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞:", error);
        }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–∞—Ç–µ–º–Ω—ë–Ω–Ω—ã–π —Ñ–æ–Ω
    document.addEventListener("DOMContentLoaded", function() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadBalance();
        
        const modal = document.getElementById("orderModal");
        const modalBackdrop = document.getElementById("modalBackdrop");
        
        if (modalBackdrop) {
            modalBackdrop.addEventListener("click", function() {
                closeOrderModal();
            });
        }

        const modalContent = document.getElementById("modalContent");
        if (modalContent) {
            modalContent.addEventListener("click", function(e) {
                e.stopPropagation();
            });
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
        document.addEventListener("keydown", function(e) {
            if (e.key === "Escape" && !modal.classList.contains("hidden")) {
                closeOrderModal();
            }
        });
    });
</script>

<style>
    .qty-btn {
        background-color: #ddd;
        border: none;
        padding: 5px 10px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .qty-btn:hover {
        background-color: #bbb;
    }

    .qty-input {
        width: 50px;
        text-align: center;
        border: 1px solid #ddd;
        padding: 5px;
        margin: 0 5px;
        font-size: 16px;
    }

    .btn__del {
        background-color: transparent;
        border: none;
        font-size: 22px;
        cursor: pointer;
        transition: transform 0.2s, color 0.2s;
    }

    .btn__del:hover {
        color: #cc0000;
        transform: scale(1.2);
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
    @keyframes modalAppear {
        from {
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .animate-modal-appear {
        animation: modalAppear 0.3s ease-out;
    }
</style>
{% endblock %}