<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="/static/js/tracker.js?v=2.1"></script>
    <script src="/static/js/tracker-integrations.js?v=2.1"></script>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
        async function refreshAccessToken() {
            try {
                let response = await fetch("http://localhost:7777/auth/refresh", {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    console.log("Access token –æ–±–Ω–æ–≤–ª—ë–Ω!");
                    return true;
                } else {
                    console.warn("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞.");
                    return false;
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:", error);
                return false;
            }
        }

        // –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è fetch —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞
        let isRefreshing = false;
        let refreshPromise = null;

        window.authFetch = async function(url, options = {}) {
            if (url.includes('/auth/refresh') || url.includes('/auth/login') || url.includes('/auth/register')) {
                return await fetch(url, {
                    ...options,
                    credentials: 'include'
                });
            }

            // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å
            let response = await fetch(url, {
                ...options,
                credentials: 'include'
            });

            // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ 401, –ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ —Ñ–æ–Ω–µ
            if (response.status === 401) {
                if (isRefreshing && refreshPromise) {
                    // –ñ–¥—ë–º, –ø–æ–∫–∞ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å –æ–±–Ω–æ–≤–∏—Ç —Ç–æ–∫–µ–Ω
                    await refreshPromise;
                    response = await fetch(url, {
                        ...options,
                        credentials: 'include'
                    });
                } else {
                    isRefreshing = true;
                    refreshPromise = refreshAccessToken();
                    const refreshed = await refreshPromise;
                    isRefreshing = false;
                    refreshPromise = null;

                    if (refreshed) {
                        response = await fetch(url, {
                            ...options,
                            credentials: 'include'
                        });
                    }
                }
            }

            return response;
        };

        async function logoutUser() {
            const url = "http://localhost:7777/auth/logout";
            await fetch(url, {
                method: 'POST',
                credentials: 'include'
            }).then(response => {
                if (response.status === 200) {
                    document.cookie = "access_token=; Max-Age=0; path=/";
                    document.cookie = "refresh_token=; Max-Age=0; path=/";
                    window.location.href = "/pages/login";
                }
            });
        }

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
        window.updateBalance = async function() {
            const authButton = document.getElementById("auth-button");
            if (!authButton) return;
            
            try {
                let response = await window.authFetch("http://localhost:7777/auth/me", {
                    method: 'GET'
                });

                if (response.ok) {
                    const userData = await response.json();
                    const balance = userData.balance || 0;
                    authButton.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="bg-blue-500 text-white px-3 py-1 rounded text-sm font-semibold">
                                üí∞ ${balance} ‚ÇΩ
                            </span>
                            <a href="/pages/profile" class="bg-green-500 text-white px-4 py-2 rounded">–ü—Ä–æ—Ñ–∏–ª—å</a>
                        </div>
                    `;
                } else {
                    authButton.innerHTML = '<a href="/pages/login" class="bg-blue-500 text-white px-4 py-2 rounded">–í–æ–π—Ç–∏</a>';
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:", error);
            }
        };

        document.addEventListener("DOMContentLoaded", async function () {
            const authButton = document.getElementById("auth-button");

            // –°–ø–∏—Å–æ–∫ –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
            const protectedPages = ["/pages/profile", "/pages/cart"];
            const authPages = ["/pages/login", "/pages/register"];

            async function checkAuth() {
                try {
                    let response = await window.authFetch("http://localhost:7777/auth/me", {
                        method: 'GET'
                    });

                    if (response.ok) {
                        const userData = await response.json();
                        const balance = userData.balance || 0;
                        authButton.innerHTML = `
                            <div class="flex items-center gap-3">
                                <span class="bg-blue-500 text-white px-3 py-1 rounded text-sm font-semibold">
                                    ${balance} ‚ÇΩ
                                </span>
                                <a href="/pages/profile" class="bg-green-500 text-white px-4 py-2 rounded">–ü—Ä–æ—Ñ–∏–ª—å</a>
                            </div>
                        `;
                    } else {
                        authButton.innerHTML = '<a href="/pages/login" class="bg-blue-500 text-white px-4 py-2 rounded">–í–æ–π—Ç–∏</a>';
                    }
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:", error);
                    authButton.innerHTML = '<a href="/pages/login" class="bg-blue-500 text-white px-4 py-2 rounded">–í–æ–π—Ç–∏</a>';
                }
            }

            async function checkIfProtectedPage() {
                if (protectedPages.includes(window.location.pathname)) {
                    let response = await window.authFetch("http://localhost:7777/auth/me", {
                        method: 'GET'
                    });

                    if (response.status === 401) {
                        window.location.href = "/pages/login";
                    }
                }
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∫–æ—Ä–∑–∏–Ω—ã
            window.updateCartBadge = async function() {
                try {
                    const response = await window.authFetch("http://localhost:7777/cart/", {
                        method: 'GET'
                    });
                    
                    if (response.ok) {
                        const cartData = await response.json();
                        const cartBadge = document.getElementById("cart-badge");
                        
                        if (cartBadge) {
                            let totalQuantity = 0;
                            if (Array.isArray(cartData)) {
                                totalQuantity = cartData.reduce((sum, item) => sum + (item.quantity || 0), 0);
                            }
                            
                            if (totalQuantity > 0) {
                                cartBadge.textContent = totalQuantity;
                                cartBadge.classList.remove("hidden");
                            } else {
                                cartBadge.classList.add("hidden");
                            }
                        }
                    }
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã:", error);
                }
            };

            const currentPath = window.location.pathname;

            if (!authPages.includes(currentPath)) {
                await checkAuth();
                await checkIfProtectedPage();
                await updateCartBadge();
            } else {
                try {
                    await checkAuth();
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:", e);
                }
            }

            document.body.addEventListener('click', async function (event) {
                const link = event.target.closest("a");

                if (link && link.href && link.href.startsWith(window.location.origin)) {
                    event.preventDefault();
                    const targetUrl = link.href;

                    await checkAuth();

                    window.location.href = targetUrl;
                }
            });
        });
    </script>

    {% block head %}{% endblock %}
    <title>–ú–æ–π –º–∞–≥–∞–∑–∏–Ω</title>
</head>
<body>
<nav class="mb-10">
    <div class="flex justify-between px-8 py-3 text-2xl">
        <ul>
            <li><a href="/pages/products/">–ú–æ–π –º–∞–≥–∞–∑–∏–Ω</a></li>
        </ul>
        <ul class="flex gap-x-5 items-center">
            <li class="relative">
                <a href="/pages/cart" class="flex items-center gap-2">
                    –ö–æ—Ä–∑–∏–Ω–∞
                    <span id="cart-badge" class="hidden bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center min-w-[20px]"></span>
                </a>
            </li>
            <li id="auth-button"></li>
        </ul>
    </div>
    <hr/>
</nav>

{% block content %}
{% endblock %}
</body>
</html>